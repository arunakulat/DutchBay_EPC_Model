name: Release Run

on:
  push:
    tags:
      - 'v*'          # trigger on version tags like v0.1.5
  workflow_dispatch: {}  # allow manual runs if needed

permissions:
  contents: write       # required to create releases & upload assets

jobs:
  build-and-release:
    name: Build + Validate + Release
    runs-on: ubuntu-latest
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Belt-and-suspenders: make sure a stray file ".venv" cannot break anything
      - name: Ensure .venv is not a file
        run: |
          if [ -f .venv ] && [ ! -d .venv ]; then
            echo "Removing tracked .venv file so python3 -m venv can create a directory (if ever used)"
            rm -f .venv
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (no venv on CI)
        run: |
          python -m pip install -U pip
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            python -m pip install -e .
          else
            python -m pip install pyyaml jsonschema numpy-financial
          fi

      - name: Validate scenario (strict)
        env:
          VALIDATION_MODE: strict
        run: |
          python -m dutchbay_v13.validate dutchbay_v13/inputs/scenarios/release_case.yaml

      - name: Run scenario -> _out
        run: |
          rm -rf _out && mkdir -p _out
          python -m dutchbay_v13 \
            --mode irr \
            --config dutchbay_v13/inputs/scenarios/release_case.yaml \
            --out _out \
            --fmt csv
          ls -l _out

      - name: Assert expected outputs exist
        id: assert_outputs
        shell: bash
        run: |
          test -f _out/summary.json
          shopt -s nullglob
          files=( _out/*_results_*.csv )
          if [ ${#files[@]} -eq 0 ]; then
            echo "No results CSV produced" >&2
            exit 1
          fi
          echo "results_csv=${files[0]}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            _out/summary.json
            ${{ steps.assert_outputs.outputs.results_csv }}